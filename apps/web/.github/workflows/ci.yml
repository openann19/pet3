name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  NODE_VERSION: '20.x'
  PNPM_VERSION: '8'

jobs:
  quality-gates:
    name: Quality Gates
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        working-directory: apps/web
        run: pnpm install --frozen-lockfile

      - name: Type check
        working-directory: apps/web
        run: pnpm type-check

      - name: Lint
        working-directory: apps/web
        run: pnpm lint

      - name: Format check
        working-directory: apps/web
        run: pnpm format:check

      - name: Stylelint
        working-directory: apps/web
        run: pnpm stylelint

      - name: Security audit
        working-directory: apps/web
        run: |
          pnpm audit --audit-level=moderate || true
          echo "Security audit completed (non-blocking)"

      - name: Dependency check
        working-directory: apps/web
        run: pnpm depcheck || true

      - name: Run tests with coverage
        working-directory: apps/web
        run: pnpm test:coverage

      - name: Check coverage thresholds
        working-directory: apps/web
        run: |
          echo "Coverage thresholds validated by vitest.config.ts"
          echo "Target: 80% lines, 80% branches, 80% functions, 80% statements"

      - name: Upload coverage reports
        uses: codecov/codecov-action@v5
        if: always()
        with:
          files: ./apps/web/coverage/lcov.info
          flags: unittests
          name: codecov-web
          fail_ci_if_error: false

      - name: Build
        working-directory: apps/web
        run: pnpm build
        env:
          VITE_ENVIRONMENT: production
          VITE_USE_MOCKS: false

      - name: Check bundle size
        working-directory: apps/web
        run: pnpm check:budget

      - name: Check for forbidden words
        working-directory: apps/web
        run: pnpm forbid || true

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: quality-gates
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        working-directory: apps/web
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        working-directory: apps/web
        run: pnpm exec playwright install --with-deps chromium

      - name: Run E2E tests
        working-directory: apps/web
        run: pnpm e2e
        env:
          CI: true

      - name: Upload E2E test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: apps/web/test-results/
          retention-days: 7

  accessibility-tests:
    name: Accessibility Tests
    runs-on: ubuntu-latest
    needs: quality-gates
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        working-directory: apps/web
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        working-directory: apps/web
        run: pnpm exec playwright install --with-deps chromium

      - name: Build for testing
        working-directory: apps/web
        run: pnpm build

      - name: Run accessibility tests
        working-directory: apps/web
        run: pnpm exec playwright test tests/accessibility.spec.ts

  build-verification:
    name: Build Verification
    runs-on: ubuntu-latest
    needs: [quality-gates]
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        working-directory: apps/web
        run: pnpm install --frozen-lockfile

      - name: Production build
        working-directory: apps/web
        run: pnpm build
        env:
          VITE_ENVIRONMENT: production
          VITE_USE_MOCKS: false
          VITE_API_URL: https://api.pawfectmatch.com/api/v1
          VITE_WS_URL: wss://api.pawfectmatch.com/ws

      - name: Verify build artifacts
        working-directory: apps/web
        run: |
          if [ ! -d "dist" ]; then
            echo "❌ Build failed: dist directory not found"
            exit 1
          fi
          if [ ! -f "dist/index.html" ]; then
            echo "❌ Build failed: index.html not found"
            exit 1
          fi
          echo "✅ Build artifacts verified"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: production-build
          path: apps/web/dist
          retention-days: 1
