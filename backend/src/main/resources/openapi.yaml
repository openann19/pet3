openapi: 3.1.0
info:
  title: PawfectMatch Pet Matching API
  version: 1.0.0
  description: Production-grade pet matching system for dogs and cats with explainable scores, strict safety, and full admin controls.
  contact:
    name: API Support
    email: api@pawfectmatch.com

servers:
  - url: https://api.pawfectmatch.com/v1
    description: Production
  - url: https://staging-api.pawfectmatch.com/v1
    description: Staging

security:
  - PASETO: []
  - JWT: []

paths:
  /api/pets/{id}:
    get:
      summary: Get pet profile (public)
      operationId: getPetProfile
      tags:
        - Pets
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: If-None-Match
          in: header
          schema:
            type: string
          description: ETag for caching
      responses:
        '200':
          description: Pet profile
          headers:
            ETag:
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PetPublic'
        '304':
          description: Not Modified
        '404':
          $ref: '#/components/responses/NotFound'

  /api/me/pets:
    get:
      summary: Get my pets (includes pending media)
      operationId: getMyPets
      tags:
        - Pets
      security:
        - PASETO: []
        - JWT: []
      responses:
        '200':
          description: List of pets
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Pet'

  /api/matching/discover:
    post:
      summary: Discover ranked candidates
      operationId: discoverCandidates
      tags:
        - Matching
      security:
        - PASETO: []
        - JWT: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DiscoverRequest'
      responses:
        '200':
          description: Ranked candidates
          headers:
            ETag:
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DiscoverResponse'
        '400':
          $ref: '#/components/responses/BadRequest'

  /api/matching/score:
    post:
      summary: Calculate match score and explanation
      operationId: calculateMatchScore
      tags:
        - Matching
      security:
        - PASETO: []
        - JWT: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ScoreRequest'
      responses:
        '200':
          description: Match score and explanation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScoreResponse'
        '400':
          $ref: '#/components/responses/BadRequest'

  /api/preferences:
    get:
      summary: Get owner preferences
      operationId: getPreferences
      tags:
        - Preferences
      security:
        - PASETO: []
        - JWT: []
      responses:
        '200':
          description: Owner preferences
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OwnerPreferences'
    put:
      summary: Update owner preferences
      operationId: updatePreferences
      tags:
        - Preferences
      security:
        - PASETO: []
        - JWT: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OwnerPreferencesUpdate'
      responses:
        '200':
          description: Updated preferences
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OwnerPreferences'
        '400':
          $ref: '#/components/responses/BadRequest'

  /api/swipe:
    post:
      summary: Swipe (like/pass)
      operationId: swipe
      tags:
        - Matching
      security:
        - PASETO: []
        - JWT: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SwipeRequest'
      responses:
        '200':
          description: Swipe recorded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SwipeResponse'
        '400':
          $ref: '#/components/responses/BadRequest'

  /api/matches:
    get:
      summary: Get my matches
      operationId: getMatches
      tags:
        - Matches
      security:
        - PASETO: []
        - JWT: []
      parameters:
        - name: cursor
          in: query
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
            maximum: 100
      responses:
        '200':
          description: List of matches
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MatchesResponse'

  /api/report:
    post:
      summary: Report a pet
      operationId: reportPet
      tags:
        - Moderation
      security:
        - PASETO: []
        - JWT: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReportRequest'
      responses:
        '200':
          description: Report submitted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReportResponse'
        '400':
          $ref: '#/components/responses/BadRequest'

  /api/admin/matching/config:
    get:
      summary: Get matching configuration
      operationId: getMatchingConfig
      tags:
        - Admin
      security:
        - PASETO: []
        - JWT: []
      parameters:
        - name: species
          in: query
          schema:
            $ref: '#/components/schemas/Species'
        - name: region
          in: query
          schema:
            type: string
      responses:
        '200':
          description: Matching configuration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MatchingConfig'
    put:
      summary: Update matching configuration
      operationId: updateMatchingConfig
      tags:
        - Admin
      security:
        - PASETO: []
        - JWT: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MatchingConfigUpdate'
      responses:
        '200':
          description: Updated configuration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MatchingConfig'
        '400':
          $ref: '#/components/responses/BadRequest'

  /api/admin/taxonomy:
    get:
      summary: Get breed taxonomy
      operationId: getTaxonomy
      tags:
        - Admin
      security:
        - PASETO: []
        - JWT: []
      parameters:
        - name: species
          in: query
          schema:
            $ref: '#/components/schemas/Species'
      responses:
        '200':
          description: Breed taxonomy
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/BreedTaxonomy'
    put:
      summary: Update breed taxonomy
      operationId: updateTaxonomy
      tags:
        - Admin
      security:
        - PASETO: []
        - JWT: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: '#/components/schemas/BreedTaxonomy'
      responses:
        '200':
          description: Updated taxonomy
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/BreedTaxonomy'

  /api/admin/metrics/matching:
    get:
      summary: Get matching metrics
      operationId: getMatchingMetrics
      tags:
        - Admin
      security:
        - PASETO: []
        - JWT: []
      parameters:
        - name: species
          in: query
          schema:
            $ref: '#/components/schemas/Species'
        - name: region
          in: query
          schema:
            type: string
        - name: startDate
          in: query
          schema:
            type: string
            format: date
        - name: endDate
          in: query
          schema:
            type: string
            format: date
      responses:
        '200':
          description: Matching metrics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MatchingMetrics'

components:
  securitySchemes:
    PASETO:
      type: http
      scheme: bearer
      bearerFormat: PASETO
      description: PASETO v4 public token
    JWT:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT (HS256 or Ed25519)

  schemas:
    Species:
      type: string
      enum: [DOG, CAT]

    LifeStage:
      type: string
      enum: [PUPPY, KITTEN, YOUNG, ADULT, SENIOR]

    PetSize:
      type: string
      enum: [TOY, SMALL, MEDIUM, LARGE, GIANT, SMALL_CAT, MEDIUM_CAT, LARGE_CAT]

    Sex:
      type: string
      enum: [MALE, FEMALE]

    NeuterStatus:
      type: string
      enum: [INTACT, NEUTERED, UNKNOWN]

    Intent:
      type: string
      enum: [PLAYDATE, COMPANIONSHIP, ADOPTION, BREEDING]

    ModerationStatus:
      type: string
      enum: [PENDING, APPROVED, HELD_FOR_KYC, REJECTED]

    AggressionFlags:
      type: object
      required: [hasFlag]
      properties:
        hasFlag:
          type: boolean
        reason:
          type: string

    HealthData:
      type: object
      required: [vaccinationsUpToDate, aggressionFlags]
      properties:
        vaccinationsUpToDate:
          type: boolean
        lastVetCheck:
          type: string
          format: date
        specialNeeds:
          type: array
          items:
            type: string
        aggressionFlags:
          $ref: '#/components/schemas/AggressionFlags'
        biteHistory:
          type: boolean
        attackHistory:
          type: boolean

    TemperamentData:
      type: object
      required: [energyLevel, friendliness, playfulness, calmness, independence]
      properties:
        energyLevel:
          type: integer
          minimum: 0
          maximum: 5
        friendliness:
          type: integer
          minimum: 0
          maximum: 5
        playfulness:
          type: integer
          minimum: 0
          maximum: 5
        calmness:
          type: integer
          minimum: 0
          maximum: 5
        independence:
          type: integer
          minimum: 0
          maximum: 5
        traits:
          type: array
          items:
            type: string

    SocializationData:
      type: object
      required: [comfortWithDogs, comfortWithCats, comfortWithKids, comfortWithStrangers]
      properties:
        comfortWithDogs:
          type: integer
          minimum: 0
          maximum: 5
        comfortWithCats:
          type: integer
          minimum: 0
          maximum: 5
        comfortWithKids:
          type: integer
          minimum: 0
          maximum: 5
        comfortWithStrangers:
          type: integer
          minimum: 0
          maximum: 5

    LocationData:
      type: object
      required: [geohash7, city, country, timezone]
      properties:
        geohash7:
          type: string
          pattern: '^[0-9a-z]{7}$'
        city:
          type: string
        country:
          type: string
        timezone:
          type: string

    Photo:
      type: object
      required: [id, url, moderationStatus]
      properties:
        id:
          type: string
          format: uuid
        url:
          type: string
          format: uri
        moderationStatus:
          $ref: '#/components/schemas/ModerationStatus'
        moderatedAt:
          type: string
          format: date-time
        moderatedBy:
          type: string
          format: uuid
        rejectionReason:
          type: string
        uploadedAt:
          type: string
          format: date-time

    PetPublic:
      type: object
      required: [id, species, breedCode, name, sex, neuterStatus, ageMonths, lifeStage, size, location]
      properties:
        id:
          type: string
          format: uuid
        species:
          $ref: '#/components/schemas/Species'
        breedCode:
          type: string
        breedMix:
          type: array
          items:
            type: string
        name:
          type: string
        sex:
          $ref: '#/components/schemas/Sex'
        neuterStatus:
          $ref: '#/components/schemas/NeuterStatus'
        ageMonths:
          type: integer
          minimum: 0
        lifeStage:
          $ref: '#/components/schemas/LifeStage'
        size:
          $ref: '#/components/schemas/PetSize'
        location:
          $ref: '#/components/schemas/LocationData'
        media:
          type: array
          items:
            $ref: '#/components/schemas/Photo'
        bio:
          type: string
        intents:
          type: array
          items:
            $ref: '#/components/schemas/Intent'

    Pet:
      allOf:
        - $ref: '#/components/schemas/PetPublic'
        - type: object
          properties:
            ownerId:
              type: string
              format: uuid
            weightKg:
              type: number
              minimum: 0
            health:
              $ref: '#/components/schemas/HealthData'
            temperament:
              $ref: '#/components/schemas/TemperamentData'
            socialization:
              $ref: '#/components/schemas/SocializationData'
            vetVerified:
              type: boolean
            kycVerified:
              type: boolean
            createdAt:
              type: string
              format: date-time
            updatedAt:
              type: string
              format: date-time

    OwnerPreferences:
      type: object
      required: [maxDistanceKm, globalSearch, requireVaccinations]
      properties:
        ownerId:
          type: string
          format: uuid
        maxDistanceKm:
          type: number
          minimum: 0
          maximum: 20000
        speciesAllowed:
          type: array
          items:
            $ref: '#/components/schemas/Species'
        sizeCompatible:
          type: array
          items:
            $ref: '#/components/schemas/PetSize'
        intentsAllowed:
          type: array
          items:
            $ref: '#/components/schemas/Intent'
        lifeStageWindow:
          type: array
          items:
            $ref: '#/components/schemas/LifeStage'
        scheduleWindows:
          type: array
          items:
            type: string
        globalSearch:
          type: boolean
        requireVaccinations:
          type: boolean
        updatedAt:
          type: string
          format: date-time

    OwnerPreferencesUpdate:
      type: object
      properties:
        maxDistanceKm:
          type: number
          minimum: 0
          maximum: 20000
        speciesAllowed:
          type: array
          items:
            $ref: '#/components/schemas/Species'
        sizeCompatible:
          type: array
          items:
            $ref: '#/components/schemas/PetSize'
        intentsAllowed:
          type: array
          items:
            $ref: '#/components/schemas/Intent'
        lifeStageWindow:
          type: array
          items:
            $ref: '#/components/schemas/LifeStage'
        scheduleWindows:
          type: array
          items:
            type: string
        globalSearch:
          type: boolean
        requireVaccinations:
          type: boolean

    DiscoverRequest:
      type: object
      required: [petId]
      properties:
        petId:
          type: string
          format: uuid
        filters:
          type: object
          properties:
            species:
              $ref: '#/components/schemas/Species'
            size:
              type: array
              items:
                $ref: '#/components/schemas/PetSize'
            lifeStage:
              type: array
              items:
                $ref: '#/components/schemas/LifeStage'
            intents:
              type: array
              items:
                $ref: '#/components/schemas/Intent'
        pageCursor:
          type: string
        limit:
          type: integer
          default: 20
          maximum: 100

    CandidatePet:
      type: object
      properties:
        pet:
          $ref: '#/components/schemas/PetPublic'
        score:
          type: integer
          minimum: 0
          maximum: 100
        scoreBreakdown:
          $ref: '#/components/schemas/ScoreBreakdown'

    DiscoverResponse:
      type: object
      properties:
        candidates:
          type: array
          items:
            $ref: '#/components/schemas/CandidatePet'
        nextCursor:
          type: string
        hasMore:
          type: boolean

    ScoreRequest:
      type: object
      required: [pet1Id, pet2Id]
      properties:
        pet1Id:
          type: string
          format: uuid
        pet2Id:
          type: string
          format: uuid

    ScoreBreakdown:
      type: object
      properties:
        temperamentFit:
          type: number
          minimum: 0
          maximum: 1
        energyLevelFit:
          type: number
          minimum: 0
          maximum: 1
        lifeStageProximity:
          type: number
          minimum: 0
          maximum: 1
        sizeCompatibility:
          type: number
          minimum: 0
          maximum: 1
        breedFamilyCompatibility:
          type: number
          minimum: 0
          maximum: 1
        socializationCompatibility:
          type: number
          minimum: 0
          maximum: 1
        intentMatch:
          type: number
          minimum: 0
          maximum: 1
        distanceFit:
          type: number
          minimum: 0
          maximum: 1
        healthActivityBonus:
          type: number
          minimum: 0
          maximum: 1

    ExplanationBullet:
      type: object
      properties:
        en:
          type: string
        bg:
          type: string

    MatchExplanation:
      type: object
      properties:
        positive:
          type: array
          items:
            $ref: '#/components/schemas/ExplanationBullet'
        negative:
          type: array
          items:
            $ref: '#/components/schemas/ExplanationBullet'

    ScoreResponse:
      type: object
      properties:
        score:
          type: integer
          minimum: 0
          maximum: 100
        scoreBreakdown:
          $ref: '#/components/schemas/ScoreBreakdown'
        explanation:
          $ref: '#/components/schemas/MatchExplanation'
        hardGatePassed:
          type: boolean
        hardGateReasons:
          type: array
          items:
            $ref: '#/components/schemas/HardGateReason'

    HardGateReason:
      type: object
      properties:
        code:
          type: string
          enum: [SPECIES_POLICY, SAFETY_POLICY, VACCINATION_REQUIRED, DISTANCE_LIMIT, BREEDING_POLICY, MEDIA_REQUIRED, BLOCKED]
        messageEn:
          type: string
        messageBg:
          type: string

    SwipeRequest:
      type: object
      required: [swiperPetId, swipedPetId, action]
      properties:
        swiperPetId:
          type: string
          format: uuid
        swipedPetId:
          type: string
          format: uuid
        action:
          type: string
          enum: [like, pass]

    SwipeResponse:
      type: object
      properties:
        success:
          type: boolean
        isMatch:
          type: boolean
        matchId:
          type: string
          format: uuid

    Match:
      type: object
      properties:
        id:
          type: string
          format: uuid
        pet1:
          $ref: '#/components/schemas/PetPublic'
        pet2:
          $ref: '#/components/schemas/PetPublic'
        matchScore:
          type: integer
          minimum: 0
          maximum: 100
        scoreBreakdown:
          $ref: '#/components/schemas/ScoreBreakdown'
        createdAt:
          type: string
          format: date-time

    MatchesResponse:
      type: object
      properties:
        matches:
          type: array
          items:
            $ref: '#/components/schemas/Match'
        nextCursor:
          type: string
        hasMore:
          type: boolean

    ReportRequest:
      type: object
      required: [reportedPetId, reason]
      properties:
        reportedPetId:
          type: string
          format: uuid
        reason:
          type: string

    ReportResponse:
      type: object
      properties:
        reportId:
          type: string
          format: uuid
        status:
          type: string
          enum: [pending, reviewed, resolved, dismissed]

    MatchingWeights:
      type: object
      properties:
        temperamentFit:
          type: number
          minimum: 0
          maximum: 100
        energyLevelFit:
          type: number
          minimum: 0
          maximum: 100
        lifeStageProximity:
          type: number
          minimum: 0
          maximum: 100
        sizeCompatibility:
          type: number
          minimum: 0
          maximum: 100
        breedFamilyCompatibility:
          type: number
          minimum: 0
          maximum: 100
        socializationCompatibility:
          type: number
          minimum: 0
          maximum: 100
        intentMatch:
          type: number
          minimum: 0
          maximum: 100
        distanceFit:
          type: number
          minimum: 0
          maximum: 100
        healthActivityBonus:
          type: number
          minimum: 0
          maximum: 100

    HardGatesConfig:
      type: object
      properties:
        allowCrossSpecies:
          type: boolean
        requireVaccinations:
          type: boolean
        blockAggressionConflicts:
          type: boolean
        requireApprovedMedia:
          type: boolean
        enforceNeuterPolicy:
          type: boolean
        maxDistanceKm:
          type: number
          minimum: 0

    MatchingConfig:
      type: object
      properties:
        id:
          type: string
          format: uuid
        species:
          $ref: '#/components/schemas/Species'
        region:
          type: string
        weights:
          $ref: '#/components/schemas/MatchingWeights'
        hardGates:
          $ref: '#/components/schemas/HardGatesConfig'
        isActive:
          type: boolean
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    MatchingConfigUpdate:
      type: object
      properties:
        species:
          $ref: '#/components/schemas/Species'
        region:
          type: string
        weights:
          $ref: '#/components/schemas/MatchingWeights'
        hardGates:
          $ref: '#/components/schemas/HardGatesConfig'
        isActive:
          type: boolean

    BreedTaxonomy:
      type: object
      required: [code, species, nameEn, nameBg]
      properties:
        code:
          type: string
        species:
          $ref: '#/components/schemas/Species'
        nameEn:
          type: string
        nameBg:
          type: string
        synonyms:
          type: array
          items:
            type: string
        family:
          type: string
        sizeCategory:
          type: string
        typicalWeightMinKg:
          type: number
        typicalWeightMaxKg:
          type: number
        temperamentTags:
          type: array
          items:
            type: string
        energyLevel:
          type: integer
          minimum: 0
          maximum: 5

    MatchingMetrics:
      type: object
      properties:
        metricDate:
          type: string
          format: date
        species:
          $ref: '#/components/schemas/Species'
        region:
          type: string
        totalDiscoveries:
          type: integer
        totalMatches:
          type: integer
        avgMatchScore:
          type: number
        p50DiscoveryMs:
          type: integer
        p95DiscoveryMs:
          type: integer
        cacheHitRate:
          type: number
        hardGateRejections:
          type: object
          additionalProperties:
            type: integer

  responses:
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
              message:
                type: string

    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
              message:
                type: string
              validationErrors:
                type: array
                items:
                  type: object

